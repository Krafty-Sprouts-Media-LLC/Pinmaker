name: Deploy to Pinmaker

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio black flake8
    
    - name: Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Format check with black
      run: |
        black --check --diff .
    
    - name: Test with pytest
      run: |
        pytest --tb=short -v
      continue-on-error: true  # Don't fail deployment if tests fail
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package.json
    
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Build frontend
      run: |
        cd frontend
        npm run build
    
    - name: Test frontend
      run: |
        cd frontend
        npm run test -- --run
      continue-on-error: true

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to Pinmaker
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          echo "üöÄ Starting deployment..."
          
          # Navigate to project directory
          cd /opt/Pinmaker || {
            echo "‚ùå Project directory not found. Please run initial setup first."
            exit 1
          }
          
          # Create backup before deployment
          echo "üì¶ Creating backup..."
          ./backup.sh daily || echo "‚ö†Ô∏è Backup failed, continuing..."
          
          # Pull latest changes
          echo "üì• Pulling latest changes..."
          git stash || true
          git pull origin main || git pull origin master || {
            echo "‚ùå Git pull failed"
            exit 1
          }
          
          # Update Python dependencies
          echo "üêç Updating Python dependencies..."
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # Build frontend
          echo "üé® Building frontend..."
          cd frontend
          npm ci
          npm run build
          cd ..
          
          # Run database migrations (if any)
          echo "üóÑÔ∏è Running migrations..."
          # python manage.py migrate || echo "No migrations to run"
          
          # Restart services
          echo "üîÑ Restarting services..."
          sudo systemctl restart pinmaker
          sudo systemctl restart nginx
          
          # Health check
          echo "üè• Performing health check..."
          sleep 5
          
          # Check if services are running
          if sudo systemctl is-active --quiet pinmaker; then
            echo "‚úÖ Pinmaker service is running"
          else
            echo "‚ùå Pinmaker service failed to start"
            sudo journalctl -u pinmaker --no-pager -n 20
            exit 1
          fi
          
          if sudo systemctl is-active --quiet nginx; then
            echo "‚úÖ Nginx service is running"
          else
            echo "‚ùå Nginx service failed to start"
            sudo journalctl -u nginx --no-pager -n 20
            exit 1
          fi
          
          # Test application endpoint
          echo "üåê Testing application endpoint..."
          if curl -f -s http://localhost:8000/health > /dev/null; then
            echo "‚úÖ Application is responding"
          else
            echo "‚ö†Ô∏è Application health check failed, but services are running"
          fi
          
          echo "üéâ Deployment completed successfully!"
    
    - name: Notify deployment status
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        text: |
          Deployment to VPS: ${{ job.status }}
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      continue-on-error: true

  rollback:
    runs-on: ubuntu-latest
    if: failure() && github.ref == 'refs/heads/main'
    needs: deploy
    
    steps:
    - name: Rollback deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          echo "üîÑ Rolling back deployment..."
          cd /opt/Pinmaker
          ./deploy.sh rollback
          echo "‚úÖ Rollback completed"